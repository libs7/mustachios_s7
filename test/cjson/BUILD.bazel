load("@rules_cc//cc:defs.bzl", "cc_library")

load("//:BUILD.bzl",
     "BASE_SRCS", "BASE_DEPS",
     "BASE_COPTS", "BASE_INCLUDE_PATHS",
     "BASE_DEFINES", "BASE_LINKOPTS",
     "TIMEOUT")

# load("//test:BUILD.bzl",
#      "TEST_SRCS", "TEST_DEPS", "TEST_INCLUDE_PATHS",
#      "TEST_COPTS", "TEST_DEFINES", "TEST_LINKOPTS",
#      "TIMEOUT")

SRCS = BASE_SRCS + [
    "//test:common.c", "//test:common.h",
    "macros.h"
] + select({
    # "//config/clibs/link:shared?": [
    #     "//lib/libmustachios:libmustachios7_s7.c"],
    "//conditions:default": []
})

DEPS = BASE_DEPS + [
    "//lib:mustachios_s7",
    "@cjson_s7//lib:cjson_s7",
    "@gopt//lib:gopt",
    "@unity//lib:unity",
    "@uthash//lib:uthash"
] + select({
    # "//config/clibs/link:archive?": [
    #     "//lib/libmustachios:mustachios_s7_archive",
    # ],
    "//conditions:default": []
})

INCLUDE_PATHS = BASE_INCLUDE_PATHS + [
    "-Isrc",
    "-Iconfig",
    "-Itest",

    # "-Iexternal/gopt~{}/lib".format(GOPT_VERSION),
    # "-Iexternal/unity~{}/lib".format(UNITY_VERSION),
    # "-Iexternal/uthash~{}/lib".format(UTHASH_VERSION),
    # "-Iexternal/liblogc~{}/lib".format(LIBLOGC_VERSION),

    # "-Itest/unit",
    # "-Itest/libmustachios",
    # "-Itest/libmustachios/cjson",
    # "-Ilib/libmustachios",
    # "-Iexternal/libs7/lib/libmustachios",
]

COPTS         = BASE_COPTS + INCLUDE_PATHS

DATA = select({
    # "//config/clibs/link:runtime?": [
    #     "//lib/libmustachios:mustachios_s7"
    # ],
    "//conditions:default": []
})

DEFINES       = BASE_DEFINES
LINKOPTS      = BASE_LINKOPTS

TAGS = ["mustache", "json"]

################################################################
test_suite(
    name  = "cjson",
    tests = [
        ":comments",
        ":conversion",
        ":renderers",
        ":interpolation",
    ]
)

################################################################
cc_test(
    name = "comments",
    linkstatic = True,
    srcs = SRCS + ["mst_cjson_comments_test.c"],
    copts = COPTS,
    local_defines = DEFINES,
    deps = DEPS,
    data = select({
        # "//config/clibs/link:runtime?": [
        #     "//lib/libmustachios:mustachios_s7"
        # ],
        "//conditions:default": []
    }),
    linkopts = LINKOPTS,
    timeout = TIMEOUT,
    tags = TAGS + ["comments"]
)

cc_test(
    name = "conversion",
    linkstatic = True,
    srcs = SRCS + ["mst_cjson_conversion_test.c"],
    copts = COPTS,
    local_defines = DEFINES,
    deps = DEPS,
    data = select({
        # "//config/clibs/link:runtime?": [
        #     "//lib/libmustachios:mustachios_s7"
        # ],
        "//conditions:default": []
    }),
    linkopts = LINKOPTS,
    timeout = TIMEOUT,
    tags = TAGS + ["conversion"]
)

########
cc_test(
    name = "interpolation",
    linkstatic = True,
    srcs = SRCS + ["mst_cjson_interpolation_test.c"],
    copts = COPTS,
    local_defines = DEFINES,
    deps = DEPS,
    data = select({
        # "//config/clibs/link:runtime?": [
        #     "//lib/libmustachios:mustachios_s7"
        # ],
        "//conditions:default": []
    }),
    linkopts = LINKOPTS,
    timeout = TIMEOUT,
    tags = TAGS + ["interpolation"]
)

cc_test(
    name = "renderers",
    linkstatic = True,
    srcs = SRCS + ["mst_cjson_renderers_test.c"],
    copts = COPTS,
    local_defines = DEFINES,
    deps = DEPS,
    data = DATA,
    linkopts = LINKOPTS,
    timeout = TIMEOUT,
    tags = TAGS + ["renderers"]
)

################################################################
cc_test(
    name = "cjson_link_archive",
    linkstatic = True,
    srcs = ["cjson_test.c"],
    local_defines = DEFINES,
    deps = DEPS + ["//lib/libmustachios:mustache_s7_archive"],
    copts = COPTS + [
        "-Itest/unit",
        "-Iexternal/libs7/test",
        "-Ilib/libmustachios/mustach",
        "-Iexternal/libs7/lib/libmustachios/mustach",
        # "-Iexternal/mustachios7/lib",
    ],
    linkopts = LINKOPTS,
    timeout = TIMEOUT
)

cc_test(
    name = "cjson_link_shared",
    # linkstatic = True,
    srcs = ["cjson_test.c"],
    local_defines = DEFINES,
    deps = [
        "//lib:s7",
        "//lib/libmustachios:mustachios7_s7",
        "//vendored/gopt",
        "//vendored/logc",
        "//vendored/unity",
        "//vendored/uthash",
    ],
    copts = COPTS + [
        "-Itest/unit",
        "-Iexternal/mustachios7/test",
        "-Ilib/libmustachios",
        "-Iexternal/libs7/lib/libmustachios",
    ],
    linkopts = LINKOPTS,
    timeout = TIMEOUT
)

cc_test(
    name = "cjson_link_runtime",
    # linkstatic = True,
    srcs = ["cjson_test.c",
            "//lib:libs7.h", "//lib:s7.h",
            "//lib/libmustachios:mustachios7_s7",
            "//lib:s7"
            ],
    local_defines = DEFINES + ["CLIBS_LINK_RUNTIME"],
    deps = DEPS,
    # data = ["//lib/libmustachios:mustachios7_s7"],
    copts = COPTS + [
        "-Itest/unit",
        "-Ilib/libmustachios",
        "-Iexternal/libs7/lib/libmustachios",
    ],
    linkopts = LINKOPTS,
    timeout = TIMEOUT
)
